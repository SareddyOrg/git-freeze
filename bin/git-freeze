#!/bin/sh

OPTIONS_SPEC="\
freeze -l [-r <remote-name>]
freeze -t [-r] [<remote-name>] <frozen-name>
freeze -p [-a] [<remote-name>] [<frozen-name>]
freeze -f [<remote-name>]
freeze <branch-name>

Archive refs to freezer.
--
h,help    show help

 Global options
r,remote  operate on remotes
a,all     operate on all remotes

 Command options
l,list    list frozen refs
t,thaw    thaw frozen ref into a branch
p,push    push frozen ref to remote
"""

SUBDIRECTORY_OK=1
. "$(git --exec-path)/git-sh-setup"

for arg; do
    case "$arg" in
        # Global options
        -r) REMOTE_OPT=1 ; shift ;;
        -a) ALL_OPT=1 ; shift ;;

        # Command options
        -l) LIST_COMMAND=1 ; shift ;;
        -t) THAW_COMMAND=1 ; shift ;;
        -p) PUSH_COMMAND=1 ; shift ;;

        --) shift; break ;;
    esac
done

if [ $LIST_COMMAND ]; then
    echo "Frozen branches:"
    git show-ref | \
        cut -d' ' -f2 | \
        sane_grep '^refs/freezer/' | \
        sed -e 's|^refs/freezer/||'
elif [ $THAW_COMMAND ]; then
    echo thaw
elif [ $PUSH_COMMAND ]; then
    echo push
else
    BRANCH="$1"
    if [ -z $1 ]; then
        die "Branch name argument is required"
    fi

    BRANCH_REF=$(git show-ref --hash --heads "$BRANCH")
    if [ $? -ne 0 ]; then
        die "Branch does not exist: $BRANCH"
    fi

    echo Freezing branch: $BRANCH
    git update-ref refs/freezer/$BRANCH $BRANCH_REF || \
        die "Error: unable to update ref refs/freezer/$BRANCH $BRANCH_REF"
    git branch -D $BRANCH 2>&1 > /dev/null || die "Unable to delete branch $BRANCH"
fi

