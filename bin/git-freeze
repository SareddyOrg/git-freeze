#!/bin/sh

OPTIONS_SPEC="\
freeze -l [-r] [<remote-name>]
freeze -t [-r] [<remote-name>] <frozen-name>
freeze -p [-d] [<remote-name>] [<frozen-name>]
freeze -f [<remote-name>]
freeze <branch-name>

Archive refs to freezer.
--
h,help    show help

 Global options
r,remote  operate on remotes
d,delete  delete frozen branch from remotes

 Command options
l,list    list frozen refs
t,thaw    thaw frozen ref into a branch
p,push    push frozen ref to remote
f,fetch   fetch frozen ref from remote
"""

SUBDIRECTORY_OK=1
. "$(git --exec-path)/git-sh-setup"

for arg; do
    case "$arg" in
        # Global options
        -r) REMOTE_OPT=1 ; shift ;;
        -a) ALL_OPT=1 ; shift ;;
        -d) DELETE_OPT=1; shift ;;

        # Command options
        -l) LIST_COMMAND=1 ; shift ;;
        -t) THAW_COMMAND=1 ; shift ;;
        -p) PUSH_COMMAND=1 ; shift ;;
        -f) FETCH_COMMAND=1 ; shift ;;
        --) shift; break ;;
    esac
done

list() {
    if [ -z "$REMOTE_OPT" ]; then
        git show-ref --abbrev=8 | \
            sane_grep 'refs/freezer/' | \
            LANG=C LC_ALL=C sed -e 's|\([0-9a-f]*\) refs/freezer/\(.*\)|\2 (\1)|'
    else
        git ls-remote | sane_grep 'refs/freezer/' | \
            LANG=C LC_ALL=C sed -e 's|\([0-9a-f]\{8\}\).*refs/freezer/\(.*\)|\2 (\1)|'
    fi
}

thaw() {
    BRANCH="$1"
    if [ -z "$BRANCH" ]; then
        die "Frozen branch name argument required"
    fi

    FREEZER_REF=$(git show-ref --hash refs/freezer/$BRANCH)

    echo Thawing branch: $BRANCH
    git update-ref refs/heads/$BRANCH $FREEZER_REF || \
        die "Error: unable to thaw ref refs/heads/$BRANCH $FREEZER_REF"
    git update-ref -d refs/freezer/$BRANCH $FREEZER_REF
}

push() {
    if [ -z "$2" ]; then
        REMOTE=origin
        BRANCH=$1
    else
        REMOTE=$1
        BRANCH=$2
    fi

    if [ -z "$BRANCH" ]; then
        die "Frozen branch name argument required"
    fi

    if [ -z "$DELETE_OPT" ]; then
        git push "$REMOTE" "refs/freezer/$BRANCH:refs/freezer/$BRANCH"
    else
        git push "$REMOTE" ":refs/freezer/$BRANCH"
    fi
}

freeze() {
    BRANCH="$1"
    if [ -z "$BRANCH" ]; then
        die "Branch name argument is required"
    fi

    BRANCH_REF=$(git show-ref --hash --heads "$BRANCH")
    if [ $? -ne 0 ]; then
        die "Branch does not exist: $BRANCH"
    fi

    echo Freezing branch: $BRANCH
    git update-ref refs/freezer/$BRANCH $BRANCH_REF || \
        die "Error: unable to update ref refs/freezer/$BRANCH $BRANCH_REF"
    git branch -D $BRANCH 2>&1 > /dev/null || die "Unable to delete branch $BRANCH"

}

fetch() {
    REMOTE=${1:-origin}
    git fetch $REMOTE refs/freezer/\*:refs/freezer/\*
}

if [ $LIST_COMMAND ]; then
    list
elif [ $THAW_COMMAND ]; then
    thaw "$1"
elif [ $PUSH_COMMAND ]; then
    push "$1" "$2"
elif [ $FETCH_COMMAND ]; then
    fetch $1
else
    freeze "$1"
fi
